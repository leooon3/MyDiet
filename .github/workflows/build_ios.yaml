name: Build iOS for Sideloadly

on:
  push:
    branches: ["main", "dev"]
  workflow_dispatch:
    inputs:
      environment:
        description: "Seleziona Ambiente (Flavor)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod

jobs:
  build_ios_unsigned:
    name: Build iOS (${{ inputs.environment || 'dev' }})
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ./client

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.27.1"
          cache: true

      - name: Install Dependencies
        run: flutter pub get

      # 1. FIX: Installa tool per modificare progetto Xcode
      - name: Install XcodeProj Gem
        run: sudo gem install xcodeproj

      # [NUOVO] 2. INIEZIONE OPZIONI DART (Fix errore main.dart)
      # Ricrea i file ignorati lib/firebase_options_*.dart
      - name: Inject Firebase Dart Options
        run: |
          echo "${{ secrets.FIREBASE_OPTIONS_DEV }}" | base64 --decode > lib/firebase_options_dev.dart
          echo "${{ secrets.FIREBASE_OPTIONS_PROD }}" | base64 --decode > lib/firebase_options_prod.dart

      # 3. INIEZIONE CONFIGURAZIONE IOS (GoogleService-Info.plist)
      - name: Inject GoogleService-Info.plist
        run: |
          BUILD_ENV="${{ inputs.environment }}"
          if [ -z "$BUILD_ENV" ]; then BUILD_ENV="dev"; fi

          if [[ "$BUILD_ENV" == "prod" ]]; then
             echo "ðŸš€ Building for PROD - Using Prod Config"
             echo "${{ secrets.IOS_FIREBASE_CONFIG_PROD }}" | base64 --decode > ios/Runner/GoogleService-Info.plist
          else
             echo "ðŸ› ï¸ Building for DEV - Using Dev Config"
             echo "${{ secrets.IOS_FIREBASE_CONFIG_DEV }}" | base64 --decode > ios/Runner/GoogleService-Info.plist
          fi

      # 4. SUPER PATCHING (RUBY): Forza Manual Signing e Rimuove Team ID
      - name: Force Manual Signing (Ruby Script)
        run: |
          ruby -e '
            require "xcodeproj"
            path = "ios/Runner.xcodeproj"
            project = Xcodeproj::Project.open(path)
            
            project.targets.each do |target|
              if target.name == "Runner"
                puts "Patching Runner target..."
                target.build_configurations.each do |config|
                  config.build_settings["CODE_SIGN_STYLE"] = "Manual"
                  config.build_settings["CODE_SIGN_IDENTITY"] = ""
                  config.build_settings["CODE_SIGNING_REQUIRED"] = "NO"
                  config.build_settings["CODE_SIGNING_ALLOWED"] = "NO"
                  config.build_settings["DEVELOPMENT_TEAM"] = ""
                  config.build_settings["PROVISIONING_PROFILE_SPECIFIER"] = ""
                end
              end
            end
            project.save
            puts "âœ… Project patched successfully!"
          '

      # 5. BUILD IOS (Standard)
      - name: Build iOS App Bundle
        run: |
          BUILD_ENV="${{ inputs.environment }}"
          if [ -z "$BUILD_ENV" ]; then BUILD_ENV="dev"; fi

          echo "Building for environment: $BUILD_ENV"
          flutter build ios --release --no-codesign --dart-define=ENV=$BUILD_ENV

      # 6. PACKAGE IPA
      - name: Package IPA for Sideloadly
        run: |
          mkdir -p Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -r kybo_${{ inputs.environment || 'dev' }}.ipa Payload

      # 7. UPLOAD
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: kybo-ios-${{ inputs.environment || 'dev' }}
          path: client/kybo_${{ inputs.environment || 'dev' }}.ipa
