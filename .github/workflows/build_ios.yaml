name: Build iOS for Sideloadly

on:
  push:
    branches: ["main", "dev"]
  workflow_dispatch:
    inputs:
      environment:
        description: "Seleziona Ambiente (Flavor)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod

jobs:
  build_ios_unsigned:
    name: Build iOS (${{ inputs.environment }})
    runs-on: macos-latest

    defaults:
      run:
        working-directory: ./client

    steps:
      - uses: actions/checkout@v4

      # 1. Setup Flutter
      - uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.38.5" # O la tua versione
          cache: true

      # 2. Install Dependencies
      - name: Install Dependencies
        run: flutter pub get

      # 3. INIEZIONE CONFIGURAZIONE FIREBASE (Fix Crash)
      # Sceglie il segreto in base all'input 'environment'
      - name: Inject GoogleService-Info.plist
        run: |
          if [[ "${{ inputs.environment }}" == "prod" ]]; then
             echo "üöÄ Building for PROD - Using Prod Config"
             echo "${{ secrets.IOS_FIREBASE_CONFIG_PROD }}" | base64 --decode > ios/Runner/GoogleService-Info.plist
          else
             echo "üõ†Ô∏è Building for DEV - Using Dev Config"
             echo "${{ secrets.IOS_FIREBASE_CONFIG_DEV }}" | base64 --decode > ios/Runner/GoogleService-Info.plist
          fi

      # 4a. PATCHING: Disabilita forzatamente la firma nel progetto Xcode
      # Questo √® necessario perch√© 'flutter build' non accetta parametri di firma diretti
      - name: Disable Code Signing (Patch project.pbxproj)
        run: |
          cd ios/Runner.xcodeproj
          # Usa sed per modificare le impostazioni di firma nel file di progetto
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' project.pbxproj
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g' project.pbxproj
          sed -i '' 's/CODE_SIGN_STYLE = Automatic/CODE_SIGN_STYLE = Manual/g' project.pbxproj
          sed -i '' 's/DEVELOPMENT_TEAM = [^;]*;/DEVELOPMENT_TEAM = "";/g' project.pbxproj
          cd ../..

      # 4b. BUILD IOS (Clean)
      # Ora possiamo lanciare la build normale, tanto il progetto √® gi√† "patchato"
      - name: Build iOS App Bundle
        run: |
          # Impostiamo ENV a 'dev' se l'input √® vuoto
          BUILD_ENV="${{ inputs.environment }}"
          if [ -z "$BUILD_ENV" ]; then BUILD_ENV="dev"; fi

          echo "Building for environment: $BUILD_ENV"

          # Nota: Rimosso tutto ci√≤ che c'era dopo '--'
          flutter build ios --release --no-codesign --dart-define=ENV=$BUILD_ENV

      # 5. CREAZIONE IPA MANUALE
      # Flutter crea un .app, ma Sideloadly vuole un .ipa.
      # Un .ipa √® solo una cartella "Payload" zippata.
      - name: Package IPA for Sideloadly
        run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -r kybo_${{ inputs.environment }}.ipa Payload

      # 6. UPLOAD ARTIFACT
      # Scaricherai questo file da GitHub per darlo a Sideloadly
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: kybo-ios-${{ inputs.environment }}
          path: client/kybo_${{ inputs.environment }}.ipa
